<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚³ãƒ¡ãƒ³ãƒˆã‚°ãƒ©ãƒ• - zwEaU0fb_g4</title>

  <!-- ã‚¹ãƒãƒ›ã§ã®æ‹¡å¤§ç¸®å°ã‚’è¨±å¯ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />

  <!-- Chart.js & Zoom Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 1rem;
      background: #f5f5f5;
      margin: 0;
      touch-action: manipulation; /* ã‚¿ãƒƒãƒæ“ä½œã‚’æœ€é©åŒ– */
    }

    .header {
      text-align: center;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      font-weight: bold;
      color: #333;
    }

    #chart-container {
      position: relative;
      height: 50vh;
      min-height: 300px;
      max-height: 600px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      padding: 15px;
      box-sizing: border-box;
      overflow: hidden;
      /* ã‚¹ãƒãƒ›ã§ã®è‡ªç„¶ãªæ‹¡å¤§ç¸®å°ã‚’æœ‰åŠ¹åŒ– */
      touch-action: none;
    }

    #chart-wrapper {
      width: 100%;
      height: 100%;
      transform-origin: center center;
      transition: transform 0.1s ease-out;
    }

    canvas {
      background: transparent;
      width: 100% !important;
      height: 100% !important;
      cursor: pointer;
    }

    .controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      min-height: 44px; /* ã‚¿ãƒƒãƒã—ã‚„ã™ã„ã‚µã‚¤ã‚º */
      box-sizing: border-box;
    }

    #resetZoom {
      background: #42A5F5;
      color: white;
    }

    #resetZoom:hover {
      background: #1E88E5;
      transform: translateY(-1px);
    }

    #resetZoom:active {
      transform: translateY(0);
    }

    .instructions {
      margin-top: 1rem;
      padding: 12px;
      background: rgba(66, 165, 245, 0.1);
      border-radius: 8px;
      font-size: 13px;
      color: #555;
      text-align: center;
      line-height: 1.4;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(3px);
    }

    .modal-content {
      background-color: white;
      margin: 50% auto;
      transform: translateY(-50%);
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      min-width: 80px;
      transition: all 0.2s;
    }

    .modal-btn.confirm {
      background: #FF4444;
      color: white;
    }

    .modal-btn.confirm:hover {
      background: #CC3333;
    }

    .modal-btn.cancel {
      background: #eee;
      color: #333;
    }

    .modal-btn.cancel:hover {
      background: #ddd;
    }

    /* ã‚¹ãƒãƒ›å‘ã‘èª¿æ•´ */
    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }
      
      .header {
        font-size: 1.1rem;
      }
      
      #chart-container {
        height: 45vh;
        min-height: 280px;
        padding: 12px;
      }
      
      .btn {
        font-size: 13px;
        padding: 8px 14px;
      }
      
      .instructions {
        font-size: 12px;
      }

      .modal-content {
        margin: 40% auto;
        width: 95%;
        padding: 16px;
      }
    }

    @media (max-width: 480px) {
      #chart-container {
        height: 40vh;
        min-height: 250px;
      }
    }
  </style>
</head>
<body>
  <div class="header">ğŸ“Š ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã®æ¨ç§»</div>
  
  <div id="chart-container">
    <div id="chart-wrapper">
      <canvas id="commentChart"></canvas>
    </div>
  </div>
  
  <div class="controls">
    <button id="resetZoom" class="btn">ğŸ”„ ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  
  <div class="instructions">
    ğŸ“± <strong>æ“ä½œæ–¹æ³•ï¼š</strong><br>
    ãƒ”ãƒ³ãƒã§ã‚°ãƒ©ãƒ•å…¨ä½“ã‚’æ‹¡å¤§ã€ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•<br>
    ã‚°ãƒ©ãƒ•ã®ç‚¹ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è©²å½“æ™‚é–“ã®YouTubeå‹•ç”»ã«ç§»å‹•
  </div>

  <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h3>ğŸ¬ YouTubeå‹•ç”»ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ</h3>
      <p id="modalTime"></p>
      <div class="modal-buttons">
        <button id="confirmYes" class="modal-btn confirm">é–‹ã</button>
        <button id="confirmNo" class="modal-btn cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <script>
    const VIDEO_ID = "zwEaU0fb_g4";
    let chart;
    let pendingUrl = null;

    // ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ç”¨ã®å¤‰æ•°
    let scale = 1;
    let isPinching = false;
    let lastTouchDistance = 0;
    let translateX = 0;
    let translateY = 0;
    let lastTouchX = 0;
    let lastTouchY = 0;

    // ã‚¿ãƒƒãƒé–“ã®è·é›¢ã‚’è¨ˆç®—
    function getTouchDistance(e) {
      const touch1 = e.touches[0];
      const touch2 = e.touches[1];
      const dx = touch1.clientX - touch2.clientX;
      const dy = touch1.clientY - touch2.clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }

    // ãƒãƒ£ãƒ¼ãƒˆè¦ç´ ã®å–å¾—
    function getChartWrapper() {
      return document.getElementById('chart-wrapper');
    }

    // å¤‰å½¢ã‚’é©ç”¨
    function applyTransform() {
      const wrapper = getChartWrapper();
      if (wrapper) {
        wrapper.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
      }
    }

    // ã‚ºãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    function resetZoom() {
      scale = 1;
      translateX = 0;
      translateY = 0;
      applyTransform();
      if (chart) {
        chart.resetZoom();
      }
    }

    // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
    function formatTime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      
      if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
      }
    }

    // YouTube URLã‚’ç”Ÿæˆ
    function generateYouTubeUrl(videoId, timeInSeconds) {
      return `https://www.youtube.com/watch?v=${videoId}&t=${Math.floor(timeInSeconds)}s`;
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    function showConfirmModal(timeInSeconds) {
      const modal = document.getElementById('confirmModal');
      const modalTime = document.getElementById('modalTime');
      
      modalTime.textContent = `å‹•ç”»ã® ${formatTime(timeInSeconds)} ã‹ã‚‰å†ç”Ÿã—ã¾ã™`;
      pendingUrl = generateYouTubeUrl(VIDEO_ID, timeInSeconds);
      modal.style.display = 'block';
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
    function hideConfirmModal() {
      document.getElementById('confirmModal').style.display = 'none';
      pendingUrl = null;
    }

    // ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
    function createChart(data) {
      const labels = data.map(d => d.time);
      const counts = data.map(d => d.count);
      const maxTime = Math.max(...labels);

      const ctx = document.getElementById("commentChart").getContext("2d");

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "ã‚³ãƒ¡ãƒ³ãƒˆæ•°ï¼ˆ10ç§’ã”ã¨ï¼‰",
            data: counts,
            borderColor: "#42A5F5",
            backgroundColor: "rgba(66,165,245,0.15)",
            fill: true,
            tension: 0.4,
            pointRadius: 2,
            pointHoverRadius: 8,
            pointBackgroundColor: "#42A5F5",
            pointBorderColor: "#42A5F5",
            pointBorderWidth: 0,
            borderWidth: 2.5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'nearest'
          },
          onClick: (event, elements) => {
            if (elements.length > 0) {
              const elementIndex = elements[0].index;
              const timeInSeconds = labels[elementIndex];
              showConfirmModal(timeInSeconds);
            }
          },
          scales: {
            x: {
              type: 'linear',
              position: 'bottom',
              title: { 
                display: true, 
                text: "çµŒéæ™‚é–“",
                font: { size: 12, weight: 'bold' }
              },
              ticks: {
                stepSize: 1800, // 30åˆ† = 1800ç§’
                callback: function(value) {
                  return formatTime(value);
                },
                maxTicksLimit: 8,
                font: { size: 11 }
              },
              grid: {
                color: 'rgba(0,0,0,0.08)'
              }
            },
            y: {
              beginAtZero: true,
              title: { 
                display: true, 
                text: "ã‚³ãƒ¡ãƒ³ãƒˆæ•°",
                font: { size: 12, weight: 'bold' }
              },
              ticks: {
                font: { size: 11 }
              },
              grid: {
                color: 'rgba(0,0,0,0.05)'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            zoom: {
              pan: {
                enabled: true,
                mode: 'x',
                modifierKey: null,
                threshold: 5 // ã‚¹ãƒãƒ›ã§ã®æ„Ÿåº¦èª¿æ•´
              },
              zoom: {
                wheel: {
                  enabled: true,
                  speed: 0.05,
                  modifierKey: null
                },
                pinch: {
                  enabled: true
                },
                mode: 'x',
                sensitivity: 3
              },
              limits: {
                x: { 
                  min: 0,
                  max: maxTime,
                  minRange: 60 // æœ€å°1åˆ†ã®ç¯„å›²
                },
                y: { 
                  min: 0,
                  minRange: 1
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.8)',
              titleColor: 'white',
              bodyColor: 'white',
              borderColor: '#42A5F5',
              borderWidth: 1,
              cornerRadius: 6,
              displayColors: false,
              callbacks: {
                title: (context) => `æ™‚é–“: ${formatTime(context[0].parsed.x)}`,
                label: (context) => `ã‚³ãƒ¡ãƒ³ãƒˆæ•°: ${context.parsed.y}ä»¶`,
                footer: () => 'ã‚¿ãƒƒãƒ—ã§å‹•ç”»ã®ã“ã®æ™‚é–“ã«ç§»å‹•'
              }
            }
          }
        }
      });
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    fetch("../chart_data/" + VIDEO_ID + "_chart.json")
      .then(res => res.json())
      .then(data => {
        createChart(data);
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.getElementById("resetZoom").addEventListener("click", resetZoom);
        
        // ã‚¹ãƒãƒ›ã§ã®ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ å¯¾å¿œ
        const chartContainer = document.getElementById('chart-container');
        
        chartContainer.addEventListener('touchstart', (e) => {
          if (e.touches.length === 2) {
            isPinching = true;
            lastTouchDistance = getTouchDistance(e);
            e.preventDefault();
          } else if (e.touches.length === 1) {
            lastTouchX = e.touches[0].clientX;
            lastTouchY = e.touches[0].clientY;
          }
        }, { passive: false });
        
        chartContainer.addEventListener('touchmove', (e) => {
          if (isPinching && e.touches.length === 2) {
            const currentDistance = getTouchDistance(e);
            const scaleChange = currentDistance / lastTouchDistance;
            
            scale *= scaleChange;
            scale = Math.max(0.5, Math.min(scale, 5)); // 0.5å€ã‹ã‚‰5å€ã¾ã§
            
            lastTouchDistance = currentDistance;
            applyTransform();
            e.preventDefault();
          } else if (!isPinching && e.touches.length === 1 && scale > 1) {
            // ãƒ‘ãƒ³æ“ä½œï¼ˆã‚ºãƒ¼ãƒ æ™‚ã®ã¿ï¼‰
            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            
            translateX += (currentX - lastTouchX) / scale;
            translateY += (currentY - lastTouchY) / scale;
            
            lastTouchX = currentX;
            lastTouchY = currentY;
            
            applyTransform();
            e.preventDefault();
          }
        }, { passive: false });
        
        chartContainer.addEventListener('touchend', (e) => {
          if (e.touches.length < 2) {
            isPinching = false;
          }
        });
        
        // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã®ã‚ºãƒ¼ãƒ ï¼ˆPCç”¨ï¼‰
        chartContainer.addEventListener('wheel', (e) => {
          e.preventDefault();
          const delta = e.deltaY > 0 ? 0.9 : 1.1;
          scale *= delta;
          scale = Math.max(0.5, Math.min(scale, 5));
          applyTransform();
        }, { passive: false });
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById("confirmYes").addEventListener("click", () => {
          if (pendingUrl) {
            window.open(pendingUrl, '_blank');
          }
          hideConfirmModal();
        });
        
        document.getElementById("confirmNo").addEventListener("click", hideConfirmModal);
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById("confirmModal").addEventListener("click", (e) => {
          if (e.target.id === 'confirmModal') {
            hideConfirmModal();
          }
        });
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        window.addEventListener('resize', () => {
          if (chart) {
            setTimeout(() => chart.resize(), 100);
          }
        });
        
        // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            hideConfirmModal();
          }
        });
      })
      .catch(error => {
        console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        document.getElementById('chart-container').innerHTML = 
          '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;text-align:center;">' +
          '<div><p style="font-size:2rem;margin:0;">ğŸ“Š</p><p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p><p style="font-size:0.9rem;color:#999;">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„</p></div></div>';
      });
  </script>
</body>
</html>
