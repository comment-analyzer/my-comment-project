<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>コメントグラフ - zwEaU0fb_g4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes" />
  
  <!-- Chart.js & Zoom Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  
  <link rel="stylesheet" href="static/style/chart_page.css">
</head>
<body>
  <div class="header">📊 コメント数の推移</div>
  
  <div id="chart-container">
    <canvas id="commentChart"></canvas>
    <div id="scrollHint" class="scroll-hint">← スワイプで時間軸を移動 →</div>
  </div>
  
  <div id="timeInfo" class="time-info"></div>
  
  <div class="controls">
    <div class="zoom-controls">
      <button id="zoomOut" class="btn zoom-btn">−</button>
      <button id="zoomIn" class="btn zoom-btn">+</button>
    </div>
    <button id="resetZoom" class="btn">🔄 30分表示</button>
    <button id="showAll" class="btn">📊 全体表示</button>
  </div>
  
  <div class="instructions">
    📱 <strong>操作方法：</strong><br>
    <span class="mobile-only">横スワイプで時間軸を移動、+/−ボタンでズーム、ダブルタップでYouTube再生</span>
    <span class="desktop-only">マウスホイールで横スクロール、Ctrl+ホイールでズーム、ドラッグでも移動可能、ダブルクリックでYouTube再生</span><br>
    グラフの点をダブルタップ/クリックすると該当時間のYouTube動画が新しいタブで再生
  </div>

  <!-- 確認モーダル -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h3>🎬 YouTube動画を再生しますか？</h3>
      <p id="modalTime"></p>
      <div class="modal-buttons">
        <button id="confirmYes" class="modal-btn confirm">新しいタブで再生</button>
        <button id="confirmNo" class="modal-btn cancel">キャンセル</button>
      </div>
    </div>
  </div>

  <script>
    const VIDEO_ID = "zwEaU0fb_g4";
    let chart;
    let pendingTimeInSeconds = null;
    let chartData = [];
    let totalDuration = 0;
    let maxCommentCount = 0;
    
    // タッチ操作の状態管理
    let isDragging = false;
    let isScrolling = false;
    let isTooltipEnabled = true;

    // デバイス判定
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    // 時間フォーマット関数
    function formatTime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      
      if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
      }
    }

    // 時間情報を更新
    function updateTimeInfo() {
      if (!chart) return;
      
      const xScale = chart.scales.x;
      const min = Math.floor(xScale.min || 0);
      const max = Math.floor(xScale.max || totalDuration);
      const range = max - min;
      
      let rangeText = '';
      if (range >= 3600) {
        rangeText = `${Math.round(range / 3600 * 10) / 10}時間`;
      } else if (range >= 60) {
        rangeText = `${Math.round(range / 60)}分`;
      } else {
        rangeText = `${range}秒`;
      }
      
      document.getElementById('timeInfo').textContent = 
        `表示範囲: ${formatTime(min)} 〜 ${formatTime(max)} (${rangeText})`;
    }

    // YouTube URLを新しいタブで開く
    function openYouTubeVideo(timeInSeconds) {
      const url = `https://www.youtube.com/watch?v=${VIDEO_ID}&t=${Math.floor(timeInSeconds)}s`;
      window.open(url, '_blank');
    }

    // モーダル表示
    function showConfirmModal(timeInSeconds) {
      const modal = document.getElementById('confirmModal');
      const modalTime = document.getElementById('modalTime');
      
      modalTime.textContent = `動画の ${formatTime(timeInSeconds)} から再生します`;
      pendingTimeInSeconds = timeInSeconds;
      modal.style.display = 'block';
    }

    // モーダル非表示
    function hideConfirmModal() {
      document.getElementById('confirmModal').style.display = 'none';
      pendingTimeInSeconds = null;
    }

    // ツールチップの有効/無効制御
    function disableTooltip() {
      if (chart) {
        isTooltipEnabled = false;
        chart.options.plugins.tooltip.enabled = false;
        chart.update('none');
      }
    }

    function enableTooltip() {
      if (chart) {
        isTooltipEnabled = true;
        chart.options.plugins.tooltip.enabled = true;
        chart.update('none');
      }
    }

    // ズーム・パン操作
    function zoomIn() {
      if (!chart) return;
      const xScale = chart.scales.x;
      const currentMin = xScale.min || 0;
      const currentMax = xScale.max || totalDuration;
      const currentRange = currentMax - currentMin;
      const newRange = Math.max(60, currentRange * 0.5);
      const center = (currentMin + currentMax) / 2;
      
      chart.options.scales.x.min = Math.max(0, center - newRange / 2);
      chart.options.scales.x.max = Math.min(totalDuration, center + newRange / 2);
      chart.update('none');
      updateTimeInfo();
    }

    function zoomOut() {
      if (!chart) return;
      const xScale = chart.scales.x;
      const currentMin = xScale.min || 0;
      const currentMax = xScale.max || totalDuration;
      const currentRange = currentMax - currentMin;
      const newRange = Math.min(totalDuration, currentRange * 2);
      const center = (currentMin + currentMax) / 2;
      
      chart.options.scales.x.min = Math.max(0, center - newRange / 2);
      chart.options.scales.x.max = Math.min(totalDuration, center + newRange / 2);
      chart.update('none');
      updateTimeInfo();
    }

    function resetZoom() {
      if (!chart) return;
      chart.options.scales.x.min = 0;
      chart.options.scales.x.max = Math.min(1800, totalDuration);
      chart.update('none');
      updateTimeInfo();
    }

    function showAll() {
      if (!chart) return;
      chart.options.scales.x.min = 0;
      chart.options.scales.x.max = totalDuration;
      chart.update('none');
      updateTimeInfo();
    }

    // スクロールヒントの表示制御
    function showScrollHint() {
      const hint = document.getElementById('scrollHint');
      hint.classList.add('show');
    }

    function hideScrollHint() {
      const hint = document.getElementById('scrollHint');
      hint.classList.remove('show');
    }

    function showScrollHintTemporary(duration = 3000) {
      showScrollHint();
      setTimeout(hideScrollHint, duration);
    }

    // カスタムホイールイベント処理（PC用）
    function setupCustomWheelHandler() {
      if (isTouchDevice) return;
      
      const chartContainer = document.getElementById('chart-container');
      
      chartContainer.addEventListener('wheel', function(e) {
        if (!chart) return;
        
        const xScale = chart.scales.x;
        const currentMin = xScale.min || 0;
        const currentMax = xScale.max || totalDuration;
        const range = currentMax - currentMin;
        
        if (e.ctrlKey) {
          // Ctrl+ホイール：ズーム（Chart.jsのデフォルト動作を使用）
          return;
        } else {
          // 通常のホイール：パン
          e.preventDefault();
          e.stopPropagation();
          
          const deltaX = e.deltaX;
          const deltaY = e.deltaY;
          
          const scrollDelta = deltaX !== 0 ? deltaX : deltaY;
          const scrollSensitivity = range * 0.05;
          const timeShift = (scrollDelta > 0 ? 1 : -1) * scrollSensitivity;
          
          const newMin = Math.max(0, currentMin + timeShift);
          const newMax = Math.min(totalDuration, currentMax + timeShift);
          
          chart.options.scales.x.min = newMin;
          chart.options.scales.x.max = newMax;
          chart.update('none');
          
          updateTimeInfo();
        }
      }, { passive: false });
    }

    // グラフの点からデータを取得
    function getDataPointFromPosition(e) {
      const canvas = document.getElementById('commentChart');
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const elements = chart.getElementsAtEventForMode(
        { x: x, y: y }, 
        'nearest', 
        { intersect: false }, 
        false
      );
      
      if (elements.length > 0) {
        const elementIndex = elements[0].index;
        return chartData[elementIndex].time;
      }
      return null;
    }

    // PC版ダブルクリック処理
    function setupPCDoubleClick() {
      if (isTouchDevice) return;
      
      const canvas = document.getElementById('commentChart');
      let clickCount = 0;
      let clickTimer = null;
      
      canvas.addEventListener('click', function(e) {
        if (isDragging || isScrolling) {
          return;
        }
        
        clickCount++;
        
        if (clickCount === 1) {
          clickTimer = setTimeout(() => {
            clickCount = 0;
          }, 300);
        } else if (clickCount === 2) {
          clearTimeout(clickTimer);
          clickCount = 0;
          
          const timeInSeconds = getDataPointFromPosition(e);
          if (timeInSeconds !== null) {
            showConfirmModal(timeInSeconds);
          }
        }
      });
    }

    // タッチハンドリング（スマホ用）
    function setupTouchHandling() {
      if (!isTouchDevice) return;
      
      const canvas = document.getElementById('commentChart');
      
      let lastX = 0;
      let startX = 0;
      let startTime = 0;
      let isMoving = false;
      let lastTapTime = 0;
      
      canvas.addEventListener('touchstart', function(e) {
        startX = lastX = e.touches[0].clientX;
        startTime = Date.now();
        isMoving = false;
        isDragging = false;
        isScrolling = false;
        
        e.preventDefault();
      }, { passive: false });
      
      canvas.addEventListener('touchmove', function(e) {
        const currentX = e.touches[0].clientX;
        const deltaX = currentX - lastX;
        const totalDelta = Math.abs(currentX - startX);
        
        if (totalDelta > 10) {
          isMoving = true;
          isDragging = true;
          isScrolling = true;
          
          disableTooltip();
          
          if (chart && chart.scales.x) {
            const xScale = chart.scales.x;
            const currentMin = xScale.min || 0;
            const currentMax = xScale.max || totalDuration;
            const range = currentMax - currentMin;
            const canvasWidth = canvas.offsetWidth;
            const pixelRatio = range / canvasWidth;
            const timeShift = -deltaX * pixelRatio * 2;
            
            const newMin = Math.max(0, currentMin + timeShift);
            const newMax = Math.min(totalDuration, currentMax + timeShift);
            
            chart.options.scales.x.min = newMin;
            chart.options.scales.x.max = newMax;
            chart.update('none');
            
            updateTimeInfo();
            showScrollHint();
          }
        }
        
        lastX = currentX;
        e.preventDefault();
      }, { passive: false });
      
      canvas.addEventListener('touchend', function(e) {
        const endTime = Date.now();
        const touchDuration = endTime - startTime;
        const totalDistance = Math.abs(e.changedTouches[0].clientX - startX);
        
        setTimeout(hideScrollHint, 1000);
        
        // タップ判定
        const isTap = touchDuration < 300 && totalDistance < 10;
        
        if (isTap && !isMoving) {
          const currentTime = Date.now();
          const timeSinceLastTap = currentTime - lastTapTime;
          
          if (timeSinceLastTap < 500) {
            // ダブルタップ
            const fakeEvent = {
              clientX: e.changedTouches[0].clientX,
              clientY: e.changedTouches[0].clientY
            };
            
            const timeInSeconds = getDataPointFromPosition(fakeEvent);
            if (timeInSeconds !== null) {
              showConfirmModal(timeInSeconds);
            }
            
            lastTapTime = 0;
          } else {
            // 初回タップ
            lastTapTime = currentTime;
          }
        }
        
        // 状態をリセット
        setTimeout(() => {
          isDragging = false;
          isScrolling = false;
          enableTooltip();
        }, 200);
        
        e.preventDefault();
      }, { passive: false });
    }

    // チャート作成
    function createChart(data) {
      chartData = data;
      const labels = data.map(d => d.time);
      const counts = data.map(d => d.count);
      totalDuration = Math.max(...labels);
      maxCommentCount = Math.max(...counts);
      
      const yAxisMax = Math.max(maxCommentCount * 1.1, maxCommentCount + 5);

      const ctx = document.getElementById("commentChart").getContext("2d");

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "コメント数（10秒ごと）",
            data: counts,
            borderColor: "#42A5F5",
            backgroundColor: "rgba(66,165,245,0.15)",
            fill: true,
            tension: 0.4,
            pointRadius: 3,
            pointHoverRadius: 8,
            pointBackgroundColor: "#42A5F5",
            pointBorderColor: "#42A5F5",
            pointBorderWidth: 0,
            borderWidth: 2.5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'nearest'
          },
          scales: {
            x: {
              type: 'linear',
              position: 'bottom',
              min: 0,
              max: Math.min(1800, totalDuration),
              title: { 
                display: true, 
                text: "経過時間",
                font: { size: 12, weight: 'bold' }
              },
              ticks: {
                callback: function(value) {
                  return formatTime(value);
                },
                maxTicksLimit: 8,
                font: { size: 11 }
              },
              grid: {
                color: 'rgba(0,0,0,0.08)'
              }
            },
            y: {
              beginAtZero: true,
              max: yAxisMax,
              title: { 
                display: true, 
                text: "コメント数",
                font: { size: 12, weight: 'bold' }
              },
              ticks: {
                font: { size: 11 }
              },
              grid: {
                color: 'rgba(0,0,0,0.05)'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            zoom: {
              pan: {
                enabled: !isTouchDevice,
                mode: 'x',
                modifierKey: null
              },
              zoom: {
                wheel: {
                  enabled: true,
                  speed: 0.1,
                  modifierKey: 'ctrl'
                },
                pinch: {
                  enabled: isTouchDevice
                },
                mode: 'x',
                onZoomComplete: () => {
                  updateTimeInfo();
                }
              },
              limits: {
                x: { 
                  min: 0,
                  max: totalDuration,
                  minRange: 60
                },
                y: { 
                  min: 0,
                  max: yAxisMax,
                  minRange: 1
                }
              }
            },
            tooltip: {
              enabled: true,
              backgroundColor: 'rgba(0,0,0,0.8)',
              titleColor: 'white',
              bodyColor: 'white',
              borderColor: '#42A5F5',
              borderWidth: 1,
              cornerRadius: 6,
              displayColors: false,
              filter: function(tooltipItem) {
                return isTooltipEnabled;
              },
              callbacks: {
                title: (context) => `時間: ${formatTime(context[0].parsed.x)}`,
                label: (context) => `コメント数: ${context.parsed.y}件`,
                footer: () => isTouchDevice ? 'ダブルタップでYouTube再生' : 'ダブルクリックでYouTube再生'
              }
            }
          }
        }
      });

      updateTimeInfo();
      
      if (isTouchDevice) {
        setupTouchHandling();
        setTimeout(() => showScrollHintTemporary(), 500);
      } else {
        setupCustomWheelHandler();
        setupPCDoubleClick();
      }
    }

    // データ読み込み
    fetch("../chart_data/" + VIDEO_ID + "_chart.json")
      .then(res => res.json())
      .then(data => {
        createChart(data);
        
        // ボタンイベント
        document.getElementById("zoomIn").addEventListener("click", zoomIn);
        document.getElementById("zoomOut").addEventListener("click", zoomOut);
        document.getElementById("resetZoom").addEventListener("click", resetZoom);
        document.getElementById("showAll").addEventListener("click", showAll);
        
        // モーダルイベント
        document.getElementById("confirmYes").addEventListener("click", () => {
          if (pendingTimeInSeconds !== null) {
            openYouTubeVideo(pendingTimeInSeconds);
          }
          hideConfirmModal();
        });
        
        document.getElementById("confirmNo").addEventListener("click", hideConfirmModal);
        
        document.getElementById("confirmModal").addEventListener("click", (e) => {
          if (e.target.id === 'confirmModal') {
            hideConfirmModal();
          }
        });
        
        // リサイズ対応
        window.addEventListener('resize', () => {
          if (chart) {
            setTimeout(() => chart.resize(), 100);
          }
        });
        
        // ESCキー対応
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            hideConfirmModal();
          }
        });
      })
      .catch(error => {
        console.error('データの読み込みに失敗しました:', error);
        document.getElementById('chart-container').innerHTML = 
          '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;text-align:center;">' +
          '<div><p style="font-size:2rem;margin:0;">📊</p><p>データの読み込みに失敗しました</p><p style="font-size:0.9rem;color:#999;">ネットワーク接続を確認してください</p></div></div>';
      });
  </script>
</body>
</html>
